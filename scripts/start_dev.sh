#!/bin/bash

echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº Ð¥Ð°Ð±Ñ€Ð”Ð°Ð¹Ð´Ð¶ÐµÑÑ‚ Ð² Ñ€ÐµÐ¶Ð¸Ð¼Ðµ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸..."

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð°
if [ ! -f .env ]; then
    echo "âŒ Ð¤Ð°Ð¹Ð» .env Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½. Ð¡ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ env.example Ð² .env Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹Ñ‚Ðµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ."
    exit 1
fi

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ Ð»Ð¾Ð³Ð¾Ð²
mkdir -p logs

# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð±Ð°Ð·Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¸ Redis Ñ‡ÐµÑ€ÐµÐ· Docker
echo "ðŸ“¦ Ð—Ð°Ð¿ÑƒÑÐº PostgreSQL Ð¸ Redis..."
docker-compose up -d postgres redis

# Ð–Ð´ÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
echo "â³ ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…..."
sleep 10

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Python Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
pip install -r requirements.txt

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹
echo "ðŸ—„ï¸ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ‚Ð°Ð±Ð»Ð¸Ñ† Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…..."
python -c "from app.database.database import create_tables; create_tables()"

# Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ñ‹Ðµ Ñ‚ÐµÐ¼Ñ‹
echo "ðŸ“š Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ñ‹Ñ… Ñ‚ÐµÐ¼..."
python -c "from celery_app.tasks import add_default_topics; add_default_topics()"

# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Celery worker Ð² Ñ„Ð¾Ð½Ðµ
echo "ðŸ”§ Ð—Ð°Ð¿ÑƒÑÐº Celery worker..."
celery -A celery_app.celery_app worker --loglevel=info &
CELERY_PID=$!

# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Celery beat Ð² Ñ„Ð¾Ð½Ðµ
echo "â° Ð—Ð°Ð¿ÑƒÑÐº Celery beat..."
celery -A celery_app.celery_app beat --loglevel=info &
BEAT_PID=$!

# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
echo "ðŸ¤– Ð—Ð°Ð¿ÑƒÑÐº Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð³Ð¾ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ..."
python main.py

# ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð¿Ñ€Ð¸ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ð¸
echo "ðŸ›‘ ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²..."
kill $CELERY_PID $BEAT_PID 2>/dev/null
docker-compose down 